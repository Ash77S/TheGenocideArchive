<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtered Timeline View with Telegram Previews</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .timeline {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .timeline-item {
            border-left: 2px solid #6c63ff;
            padding-left: 10px;
            margin-bottom: 20px;
        }
        .timeline-item h3 {
            margin: 0;
            color: #6c63ff; /* Highlight description */
        }
        .timeline-item p {
            margin: 5px 0;
            color: #333;
        }
        .timeline-item .date {
            font-size: 0.9em;
            color: #888;
        }
        .timeline-item iframe {
            margin-top: 10px;
            width: 100%;
            height: 315px;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Filtered Timeline View with Telegram Previews</h1>
    <div class="timeline" id="timeline"></div>

    <script>
        // Function to fetch all records with pagination
        async function fetchAllRecords() {
            const allRecords = [];
            let offset = null;

            do {
                const url = `https://api.airtable.com/v0/appkpyLd4TzlG0MJf/tblijFR7QOqP28IzT?${offset ? `offset=${offset}` : ''}`;
                const response = await fetch(url, {
                    headers: {
                        Authorization: 'Bearer pat5b0ieYGAdRQDps.36b19bce15bd804b98c683c2b398b4727b157bb4346015a41226f77b74fd6d1e'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                allRecords.push(...data.records);
                offset = data.offset; // Airtable includes an offset if more records exist
            } while (offset);

            return allRecords;
        }

        // Function to display the timeline with Telegram previews
        function displayTimeline(records) {
            const timeline = document.getElementById('timeline');
            records.forEach(record => {
                const fields = record.fields;

                // Handle missing fields
                const dateText = fields.date ? `Date: ${fields.date}` : 'Date: Not provided';
                const descriptionText = fields.description || 'No description available.';
                const source1 = fields.source_1 || null;

                // Create a timeline item
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';

                // Add date
                const date = document.createElement('div');
                date.className = 'date';
                date.innerText = dateText;
                timelineItem.appendChild(date);

                // Add description (main detail)
                const description = document.createElement('h3');
                description.innerText = descriptionText;
                description.style.color = '#6c63ff'; // Highlight description
                timelineItem.appendChild(description);

                // Add Telegram preview (if source_1 is a Telegram link)
                if (source1 && source1.includes('t.me')) {
                    const telegramPreview = document.createElement('iframe');
                    telegramPreview.src = source1.replace('t.me', 'embed.t.me');
                    telegramPreview.allow = 'autoplay; encrypted-media';
                    telegramPreview.title = 'Telegram Message Preview';
                    timelineItem.appendChild(telegramPreview);
                }

                // Append the item to the timeline
                timeline.appendChild(timelineItem);
            });
        }

        // Fetch and display all records
        fetchAllRecords()
            .then(records => {
                console.log('Total records fetched:', records.length);
                if (!records.length) {
                    document.getElementById('timeline').innerHTML = '<p>No data available.</p>';
                    return;
                }

                const sortedRecords = sortRecordsByDate(records);
                displayTimeline(sortedRecords);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('timeline').innerHTML = `<p>Error fetching data: ${error.message}</p>`;
            });

        // Function to sort records by the 'date' field
        function sortRecordsByDate(records) {
            return records.sort((a, b) => {
                const dateA = new Date(a.fields.date);
                const dateB = new Date(b.fields.date);
                return dateA - dateB; // Ascending order
            });
        }
    </script>
</body>
</html>
